# 시스템 아키텍처

## 1. 개요

QMS Agent System은 의료기기 품질경영시스템(Quality Management System)을 위한 AI 기반 다중 에이전트 시스템입니다. ISO 13485 및 MFDS 규제를 준수하며, 설계 변경 관리 프로세스를 자동화합니다.

## 2. 시스템 구성도

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              사용자 (웹 브라우저)                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Frontend (React + TypeScript)                       │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │ Dashboard │  │  Login   │  │  Design  │  │Regulatory│  │  Agents  │       │
│  │   Page   │  │   Page   │  │ Changes  │  │   Page   │  │   Page   │       │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────────┘       │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐     │
│  │                    AuthContext / API Client                          │     │
│  └─────────────────────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │ HTTP/REST
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Backend (FastAPI + Python)                          │
│  ┌─────────────────────────────────────────────────────────────────────┐     │
│  │                         API Layer (v1)                               │     │
│  │  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐        │     │
│  │  │  Auth  │  │ Design │  │ Agents │  │  Docs  │  │Projects│        │     │
│  │  │ Router │  │Changes │  │ Router │  │ Router │  │ Router │        │     │
│  │  └────────┘  └────────┘  └────────┘  └────────┘  └────────┘        │     │
│  └─────────────────────────────────────────────────────────────────────┘     │
│                                      │                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐     │
│  │                       Agent Orchestrator                             │     │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐            │     │
│  │  │ Design   │  │    PM    │  │    QA    │  │    RA    │            │     │
│  │  │ Engineer │  │  Agent   │  │  Agent   │  │  Agent   │            │     │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘            │     │
│  │  ┌──────────┐  ┌──────────┐                                         │     │
│  │  │   Risk   │  │Verificat.│                                         │     │
│  │  │ Manager  │  │  Agent   │                                         │     │
│  │  └──────────┘  └──────────┘                                         │     │
│  └─────────────────────────────────────────────────────────────────────┘     │
│                                      │                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐     │
│  │                       Service Layer                                  │     │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐                           │     │
│  │  │  Gemini  │  │  GDrive  │  │ Document │                           │     │
│  │  │ Service  │  │ Service  │  │ Manager  │                           │     │
│  │  └──────────┘  └──────────┘  └──────────┘                           │     │
│  └─────────────────────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                    ┌─────────────────┼─────────────────┐
                    ▼                 ▼                 ▼
            ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
            │   SQLite/    │  │   ChromaDB   │  │ Google APIs  │
            │  PostgreSQL  │  │ (Vector DB)  │  │ (Drive, AI)  │
            └──────────────┘  └──────────────┘  └──────────────┘
```

## 3. 기술 스택

### 3.1 Frontend
| 구성요소 | 기술 | 버전 | 용도 |
|---------|------|------|------|
| UI Framework | React | 19.x | 사용자 인터페이스 |
| 언어 | TypeScript | 5.9 | 타입 안전성 |
| 빌드 도구 | Vite | 7.x | 빠른 개발 환경 |
| 스타일링 | TailwindCSS | 3.x | 유틸리티 기반 CSS |
| 라우팅 | React Router | 7.x | SPA 라우팅 |
| HTTP 클라이언트 | Axios | 1.x | API 통신 |
| 아이콘 | Lucide React | - | UI 아이콘 |

### 3.2 Backend
| 구성요소 | 기술 | 버전 | 용도 |
|---------|------|------|------|
| Web Framework | FastAPI | 0.111+ | REST API 서버 |
| 언어 | Python | 3.12 | 백엔드 로직 |
| ORM | SQLAlchemy | 2.x | 데이터베이스 매핑 |
| 마이그레이션 | Alembic | - | DB 스키마 관리 |
| 인증 | python-jose | - | JWT 토큰 |
| OAuth | google-auth | - | Google OAuth 2.0 |
| AI | Google Gemini | - | LLM 기반 분석 |

### 3.3 데이터베이스
| 구성요소 | 기술 | 용도 |
|---------|------|------|
| 관계형 DB | SQLite (개발) / PostgreSQL (운영) | 트랜잭션 데이터 |
| 벡터 DB | ChromaDB | RAG 지식베이스 (예정) |

### 3.4 외부 서비스
| 서비스 | 용도 |
|--------|------|
| Google OAuth 2.0 | 사용자 인증 |
| Google Drive API | 문서 저장소 연동 |
| Google Gemini API | AI 분석 엔진 |

## 4. 에이전트 시스템 아키텍처

### 4.1 Multi-Agent 협업 구조

```
                    ┌────────────────────────────────┐
                    │      Agent Orchestrator        │
                    │   (LangGraph State Machine)    │
                    └────────────────────────────────┘
                                   │
          ┌────────────────────────┼────────────────────────┐
          ▼                        ▼                        ▼
    ┌───────────┐            ┌───────────┐            ┌───────────┐
    │  Phase 1  │───────────▶│  Phase 2  │───────────▶│  Phase 3  │
    │ 영향분석  │            │ 위험평가  │            │ 규제검토  │
    └───────────┘            └───────────┘            └───────────┘
          │                        │                        │
    ┌─────┴─────┐            ┌─────┴─────┐            ┌─────┴─────┐
    │  Design   │            │   Risk    │            │    RA     │
    │ Engineer  │            │  Manager  │            │   Agent   │
    │   Agent   │            │   Agent   │            │           │
    └───────────┘            └───────────┘            └───────────┘
```

### 4.2 에이전트 역할 정의

| 에이전트 | 역할 | 주요 기능 |
|---------|------|----------|
| Design Engineer | 설계 엔지니어 | 설계 변경 영향 분석, 기술적 검토 |
| PM Agent | 프로젝트 관리자 | 일정/리소스 영향 평가 |
| QA Agent | 품질 보증 | 품질 요구사항 검토, 테스트 결과 검증 |
| RA Agent | 규제 담당 | ISO 13485, MFDS 규제 적합성 검토 |
| Risk Manager | 리스크 관리자 | 기존 위험 재평가, 신규 위험 식별 |
| Verification Agent | 검증 담당 | IEC 62304 기반 검증 계획 생성 |

## 5. 인증 및 보안

### 5.1 인증 흐름 (Google OAuth 2.0)

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│ Frontend │     │ Backend  │     │  Google  │     │ Frontend │
│  Login   │     │  /auth   │     │  OAuth   │     │ Callback │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │
     │ 1. 로그인 클릭  │                │                │
     ├───────────────▶│                │                │
     │                │ 2. OAuth URL   │                │
     │◀───────────────┤   생성/반환    │                │
     │                │                │                │
     │ 3. Google 리다이렉트            │                │
     ├────────────────────────────────▶│                │
     │                │                │ 4. 사용자 인증 │
     │                │                │◀──────────────▶│
     │                │                │                │
     │                │ 5. code 전달   │                │
     │                │◀───────────────┤                │
     │                │                │                │
     │                │ 6. token 교환  │                │
     │                ├───────────────▶│                │
     │                │◀───────────────┤                │
     │                │                │                │
     │                │ 7. JWT 발급 + 리다이렉트        │
     │                ├────────────────────────────────▶│
     │                │                │                │
```

### 5.2 보안 고려사항

- JWT 토큰 기반 인증 (만료 시간: 설정 가능)
- HTTPS 필수 (운영 환경)
- CORS 설정으로 허용된 도메인만 접근
- Google refresh token 암호화 저장 (향후)
- 21 CFR Part 11 전자서명 지원 예정

## 6. 규제 준수

### 6.1 지원 규제

| 규제 | 설명 | 구현 상태 |
|------|------|----------|
| ISO 13485:2016 | 의료기기 품질경영시스템 | 설계 관리 모듈 구현 |
| MFDS | 식품의약품안전처 규정 | RA Agent 통합 |
| IEC 62304 | 의료기기 소프트웨어 수명주기 | Verification Agent 체크리스트 |
| IEC 62366 | 의료기기 사용적합성 | 지식베이스 예정 |

### 6.2 설계 관리 워크플로우

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  Draft  │───▶│ Analysis│───▶│ Review  │───▶│Approved │───▶│  Done   │
│ (초안)  │    │ (분석중)│    │ (검토중)│    │ (승인됨)│    │ (완료)  │
└─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
     │              │              │              │
     │         6 Agents        QA/RA           전자서명
     │         자동 분석       수동 검토        기록 저장
```

## 7. 디렉토리 구조

```
qms-agent-system/
├── backend/
│   ├── app/
│   │   ├── agents/           # AI 에이전트 구현
│   │   │   ├── base_agent.py
│   │   │   ├── design_engineer_agent.py
│   │   │   ├── pm_agent.py
│   │   │   ├── qa_agent.py
│   │   │   ├── ra_agent.py
│   │   │   ├── risk_manager_agent.py
│   │   │   ├── verification_agent.py
│   │   │   └── orchestrator.py
│   │   ├── api/v1/           # REST API 엔드포인트
│   │   ├── core/             # 설정, 보안
│   │   ├── db/               # 데이터베이스 모델
│   │   ├── models/           # Pydantic 스키마
│   │   ├── services/         # 비즈니스 로직
│   │   └── utils/            # 유틸리티
│   ├── alembic/              # DB 마이그레이션
│   └── tests/                # 테스트
├── frontend/
│   ├── src/
│   │   ├── api/              # API 클라이언트
│   │   ├── components/       # 재사용 컴포넌트
│   │   ├── contexts/         # React Context
│   │   ├── hooks/            # 커스텀 훅
│   │   ├── layouts/          # 레이아웃
│   │   ├── pages/            # 페이지 컴포넌트
│   │   ├── services/         # 서비스 레이어
│   │   └── types/            # TypeScript 타입
│   └── public/
├── docs/                     # 문서
└── scripts/                  # 설치/배포 스크립트
```

## 8. 배포 환경

### 8.1 개발 환경
- Backend: `uvicorn app.main:app --reload` (포트 8000)
- Frontend: `npm run dev` (포트 5173)
- Database: SQLite (test.db)

### 8.2 운영 환경 (예정)
- Backend: Gunicorn + Uvicorn workers
- Frontend: Nginx 정적 파일 서빙
- Database: PostgreSQL
- 컨테이너: Docker Compose
